<!DOCTYPE HTML><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="format-detection" content="telephone=no" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.5"><script type="text/javascript" src="../jm/jquery.min.js"></script>  <link rel="stylesheet" href="../jm/jquery.mobile.min.css" /> <link rel="stylesheet" href="../css/core.css" /><link rel="stylesheet" href="../css/page.css" /><script type="text/javascript" src="../jm/jquery.mobile.min.js"></script>  <script type="text/javascript" charset="utf-8" src='../js/core.js' ></script><script type="text/javascript" charset="utf-8" src='../js/page.js' ></script><script type="text/javascript" charset="utf-8" src='../js/sqlite.js' ></script><script type="text/javascript" src="../js/page.js"></script><script type="text/javascript" src="../js/chart.js"></script><link rel="Stylesheet" type="text/css" href="../css/addshed_popwindow.css" /><link rel="stylesheet" href="../css/theme/theme.min.css" /><link rel="stylesheet" href="../css/styles.css" /><script src="../js/jquery.min.js"></script><script src="../js/mobileinit.js"></script><script src="../js/jquery.mobile.min.js"></script><script src="../js/fastclick.js"></script> <link rel="stylesheet" href="../css/pull.css" /><script type="text/javascript" charset="utf-8" src="../js/iscroll.js"></script><script type="text/javascript" charset="utf-8" src="../js/initScroll.js"></script><script type="text/javascript">	$(document).ready(function(){				reload();		});	function reload() {		var session_token = window.localStorage.session_token;		var url = IP+"/api/users/infos"					//注册时判断用户名是否已经存在		var  Authorization = "bearer " + session_token;		$.ajax({				type: "GET",		        url: url,  				success: getUserInfoSuccess,				error: getUserInfoError,       			headers: {           				"Authorization":Authorization       				}			});	}	function getUserInfoSuccess(data,status){	    show(data);	}		function getUserInfoError(data,status){	    alert("失败，可能是网络不通");	}			function addDevice() {			var  devUuid = document.getElementById("device_name").value;			var  alias = document.getElementById("device_nickname").value;			alert(devUuid);			alert(alias);			var url = IP+"/api/users/smartgates/"+ devUuid;						//注册时判断用户名是否已经存在			var checkData = {alias:alias};				$.ajax({					type: "POST",			        url: url,  					data: checkData,					success: addDeviceSuccess,					error: addDeviceError				});	}	function addDeviceSuccess(data,status){	   reload();	   //window.location.reload();	   alert("添加成功!");	}		function addDeviceError(data,status){		reload();	    alert("失败，可能是网络不通");	}	var limit = 5; // 每页条数	var curCnt = 0;  // 已显示记录条数	var totalCnt = 0;  //已经获取到记录条数	var showCnt = 0;  // 当前展开的大棚标记		function createModel(cnt,dev_uuid,dev_name,plant_name,dp_div){				var imgStr = "../images/lead.png";		var imgClass = "lead";		if(curCnt!=showCnt){			imgStr = "../images/expand.png";			imgClass = "expand";		}		// 大棚名称列		var titleHtml = "<div class='dp-title'><a href=\"javascript:selectTitle("+cnt+",'"+dev_uuid+"')\">"			+ "<div class='detail'><div class='left'>"			+ "<img src='../images/house_icon.png' class='dp-icon'/>"			+ "<div><b>"+dev_name+"</b> "+plant_name+"</div>"			+ "</div>"			+ "<div class='right'><img id='lead"+cnt+"' src='"+imgStr+"' class='"+imgClass+"' /></div></div></a></div>";				// 传感器		var html = "<div class='components' id='cgq_components_"+cnt+"' style='display:none;'>"			+ "<div class='component' id='cgq_"+cnt+"_1' style='display:none;'><div class='cgq'>"			+ "<table><tr><td id='cgq_name_"+cnt+"_1' class='name'></td></tr>"			+ "<tr><td id='cgq_"+cnt+"_1' class='yibiaoDiv'>"			+ "<div class='canvas'><div id='cgq_canvas_"+cnt+"_1_1'></div><div class='cgq_span'>空气温度℃ <span id='cgq_span_"+cnt+"_1_1'></span></div></div>"			+ "<div class='canvas2'><div id='cgq_canvas_"+cnt+"_2_1'></div><div class='cgq_span'>空气湿度%RH <span id='cgq_span_"+cnt+"_2_1'></span></div></div>"			+ "<div class='canvas'><div id='cgq_canvas_"+cnt+"_3_1'></div><div class='cgq_span'>光照Lux <span id='cgq_span_"+cnt+"_3_1'></span></div></div>"			+ "</td></tr></table></div></div>"			+ "<div class='component' id='cgq_"+cnt+"_2' style='display:none;'><div class='cgq'>"			+ "<table><tr><td id='cgq_name_"+cnt+"_2' class='name'></td></tr>"			+ "<tr><td id='cgq_"+cnt+"_2' class='yibiaoDiv'>"			+ "<div class='canvas'><div id='cgq_canvas_"+cnt+"_1_2'></div><div class='cgq_span'>CO2ppm <span id='cgq_span_"+cnt+"_1_2'></span></div></div>"			+ "<div class='canvas2'><div id='cgq_canvas_"+cnt+"_2_2'></div>"			+ "<div class='cgq_span'>光照Lux <span id='cgq_span_"+cnt+"_2_2'></span></div></div>"			+ "<div class='canvas'><div id='cgq_canvas_"+cnt+"_3_2'></div><div class='cgq_span'>PH <span id='cgq_span_"+cnt+"_3_2'></span></div></div>"			+ "</td></tr></table></div></div></div>";				html = html + "<div class='components' id='erelay_"+cnt+"'></div>";				html = html + "<div class='components' id='cameraip_"+cnt+"'></div>";				html = html + "<div class='components' id='camera_"+cnt+"'></div>";				if(showCnt==cnt){			html = "<div id='dp"+cnt+"' style='display:block;'>" + html + "</div>";		} else {			html = "<div id='dp"+cnt+"' style='display:none;'>" + html + "</div>";		}				dp_div.innerHTML = titleHtml + html;	}		function show(userInfo){		//var jsonText = JSON.stringify(userInfo);		//alert(jsonText);	　　	curCnt = 0;		var deviceList = userInfo.smartgates;		var devListDiv = document.getElementById("devListDiv");		if(deviceList.length>0){			if(curCnt==0){				devListDiv.innerHTML = "";			}		} else {			if(curCnt==0){				devListDiv.innerHTML = "<div style='text-align:center;margin-top:10px;margin-bottom:10px;'>没有大棚信息</div>";			}			return;		}		showCnt=1;				for(var i=0; i<deviceList.length; i++){			var dev_info = deviceList[i].smartgate;			totalCnt++;						var dev_uuid = dev_info.sn;			var plant_name = dev_info.plant_name;			var dev_name = dev_info.dev_name;			var components = deviceList[i].components;			if(plant_name==undefined && dev_name==undefined && components.length==0){				continue;			}						curCnt++;			var dpId = "dp_div_" + dev_info.sn;			var dp_div = document.getElementById(dpId);			//if(dp_div){  // 已经存在			//	continue;							//}						dp_div= document.createElement("div");			dp_div.id = dpId;			dp_div.setAttribute("idx",curCnt);			document.getElementById("devListDiv").appendChild(dp_div);			if(curCnt==1){				dp_div.className = "dp-first-div";			} else {				dp_div.className = "dp-div";			}						if(components.length>0){				var hasPic = "0";								createModel(curCnt,dev_uuid,dev_name,plant_name,dp_div);								var component_id;								var cgqArr1 = new Array(); // 传感器设备数据				//var cgqArr2 = new Array(); // 传感器设备数据				for(var j=0; j<components.length; j++){										var html = "";					var stateJson = getState(components[j].online_state,components[j].status);										if(components[j].dev_type=="humidity-temperature"){  // 温湿度传感器						cgqArr1.push(components[j]);					}else if (components[j].dev_type=="soil-th") {			//土壤温湿度传感器											} else if (components[j].dev_type == "illumination") {						cgqArr1.push(components[j]);					}else if (components[j].dev_type == "co") {											}else if (components[j].dev_type == "co2") {											}				}				showCgq(cgqArr1,i+1,"1");				//showCgq(cgqArr2,i+1,"2");				// 获取图片				if(hasPic=="1"){					//androidBridge.getPictureList(dev_uuid,1,4,curCnt);					showPic(main_picArr,curCnt,component_id);				}			} else {				var str = "";				var imgStr = "../images/lead.png";				var imgClass = "lead";				if(curCnt!=showCnt){					str = "style='display:none;'";					imgStr = "../images/expand.png";					imgClass = "expand";				}								dp_div.innerHTML = "<div class='dp-title'><a href=\"javascript:selectTitle("+curCnt+",'"+dev_uuid+"')\">"					+ "<div class='detail'><div class='left'>"					+ "<img src='../images/house_icon.png' class='dp-icon'/>"					+ "<div><b>"+dev_name+"</b> "+plant_name+"</div>"					+ "</div>"					+ "<div class='right'><img id='lead"+curCnt+"' src='"+imgStr+"' class='"+imgClass+"' /></div></div></a></div>"					+ "<div id='dp"+curCnt+"' "+str+"><div style='text-align:center;line-height:40px;'>没有设备信息</div></div>";			}		}	}		// 显示传感器信息	function showCgq(arr,cnt,type){		var cgq = document.getElementById("cgq_"+cnt+"_"+type);		var cgq_name = document.getElementById("cgq_name_"+cnt+"_"+type);				if(arr==null||arr.length==0){			cgq.style.display = "none";			return;		}		document.getElementById("cgq_components_"+cnt).style.display = "block";		cgq.style.display = "block";		var air_temperature = "0";		var air_humidity  = "0";		var lux = "0";				var airtemperaturesum = 0;		var luxsum = 0;		var airHumsum = 0;				var arisum = 0;		var luxTotal = 0;		for(var i=0;i<arr.length;i++){			if(arr[i].online_state = "online"){			if(arr[i].dev_type == "illumination"){				luxTotal = luxTotal+1;			 		luxsum = arr[i].lux*1+luxsum*1;							}				else{					arisum = arisum+1;			 		airtemperaturesum = airtemperaturesum*1+arr[i].air_temperature*1;			 		airHumsum = arr[i].air_humidity*1+airHumsum*1;				}			}			}		if(luxTotal !=0){			lux = luxsum/luxTotal;		}		if(arisum !=0){			air_humidity = airHumsum/arisum;			air_temperature = airtemperaturesum/arisum;		}		//alert(" lux= "+lux+" air_humidity= "+air_humidity+" air_temperature= "+air_temperature);		showCgqName(arr,"cgq_name_"+cnt+"_"+type,type,cnt);		selectCgq(1,arr.length,type,cnt,air_temperature,air_humidity,lux,arr[0].component_id);	}		var cur_cgq = "";  // 当前显示的传感器	// 选择一个传感器时显示仪表信息	function selectCgq(index,total,type,cnt,v1,v2,v3,componentId){		cur_cgq = cnt+"_"+type+"_"+index;		changeNameCss(index,total,type,cnt);		var width = document.body.scrollWidth-50;		var width = width/3-10; //每个传感器名称的tab宽		var height = width/2;				var color1 = "";		var color2 = "";		var color3 = "";		if(type==1){  // 温度、湿度、电量			var id1 = "cgq_canvas_"+cnt+"_1_"+type;			document.getElementById(id1).innerHTML = "";			drawPointImgCanvas({objId:id1,canvasId:'canvas-w-'+cnt+"-"+type,canvasWidth:width,canvasHeight:height,dialValue:v1,dialMaxValue:100,dialMinValue:-20,backgroundImage:'../images/chart1.png'});			var id2 = "cgq_canvas_"+cnt+"_2_"+type;			document.getElementById(id2).innerHTML = "";			drawPointImgCanvas({objId:id2,canvasId:'canvas-s-'+cnt+"-"+type,canvasWidth:width,canvasHeight:height,dialValue:v2,dialMaxValue:100,dialMinValue:0,backgroundImage:'../images/chart2.png',cassName:'yibiao2'});			var id3 = "cgq_canvas_"+cnt+"_3_"+type;			document.getElementById(id3).innerHTML = "";			drawPointImgCanvas({objId:id3,canvasId:'canvas-d-'+cnt+"-"+type,canvasWidth:width,canvasHeight:height,dialValue:v3,dialMaxValue:100,dialMinValue:0,backgroundImage:'../images/chart3.png'});						color1 = getColor(v1,temperatureArr);			color2 = getColor(v2,humidityArr);			color3 = getColor(v3,chargeArr);		}		v1 = v1 + "";		if(v1.indexOf(".")>-1 && (v1.indexOf(".")+3<v1.length)){			v1 = v1.substring(0,v1.indexOf(".")+3);		}		document.getElementById("cgq_span_"+cnt+"_1_"+type).innerHTML = v1;		document.getElementById("cgq_span_"+cnt+"_1_"+type).style.color = color1;		v2 = v2 + "";		if(v2.indexOf(".")>-1 && (v2.indexOf(".")+3<v2.length)){			v2 = v2.substring(0,v2.indexOf(".")+3);		}		document.getElementById("cgq_span_"+cnt+"_2_"+type).innerHTML = v2;		document.getElementById("cgq_span_"+cnt+"_2_"+type).style.color = color2;		v3 = v3 + "";		if(v3.indexOf(".")>-1 && (v3.indexOf(".")+3<v3.length)){			v3 = v3.substring(0,v3.indexOf(".")+3);		}		document.getElementById("cgq_span_"+cnt+"_3_"+type).innerHTML = v3;		document.getElementById("cgq_span_"+cnt+"_3_"+type).style.color = color3;	}		function showPic(picListJson, cnt,id){		if(picListJson==null){			return;		}		var clientWidth = document.body.clientWidth;		var imgWidth = (clientWidth/4)-10;		for(var i=0; i<picListJson.length; i++){			var picDiv = document.getElementById("pic_div_" + cnt + "_" + id);			if(picDiv){				var img = document.createElement("img");				img.className = "camera_img";				img.width = imgWidth;				img.height = imgWidth;				img.src = picListJson[i].url;				picDiv.appendChild(img);			}		}	}		// 判断是否支持触摸事件	function isTouchDevice(){		try {			document.createEvent("TouchEvent");			bindEvent();  		} catch(e) {			alert("不支持TouchEvent事件！" + e.message);		}	}	function selectTitle(cnt,dev_uuid){	if(cnt==showCnt){	  location.href = "../pages/shed_detail.html?dev_uuid="+dev_uuid;	  //location.href = "../pages/tab.html";	} else {		document.getElementById("dp"+showCnt).style.display="none";		document.getElementById("lead"+showCnt).src = "../images/expand.png";		document.getElementById("lead"+showCnt).className = "expand";				document.getElementById("dp"+cnt).style.display="block";		document.getElementById("lead"+cnt).src = "../images/lead.png";		document.getElementById("lead"+cnt).className = "lead";		showCnt = cnt;	}}		$(function ($) {		$("#addshed").hover(function () {			$(this).stop().animate({				opacity: '1'			}, 600);		}, function () {			$(this).stop().animate({				opacity: '0.6'			}, 1000);		}).on('click', function () {			$("body").append("<div id='mask'></div>");			$("#mask").addClass("mask").fadeIn("slow");			$("#LoginBox").fadeIn("slow");		});		//		//按钮的透明度		$("#loginbtn").hover(function () {			$(this).stop().animate({				opacity: '1'			}, 600);		}, function () {			$(this).stop().animate({				opacity: '0.8'			}, 1000);		});		//文本框不允许为空---按钮触发		$("#loginbtn").on('click', function () {			var device_name = $("#device_name").val();			var txtPwd = $("#device_nickname").val();			if (device_name == "" || device_name == undefined || device_name == null) {				if (device_nickname == "" || device_nickname == undefined || device_nickname == null) {					$(".warning").css({ display: 'block' });				}				else {					$("#warn").css({ display: 'block' });					$("#warn2").css({ display: 'none' });				}			}			else {				if (device_nickname == "" || device_nickname == undefined || device_nickname == null) {					$("#warn").css({ display: 'none' });					$(".warn2").css({ display: 'block' });				}				else {					$(".warning").css({ display: 'none' });				}			}		});		//文本框不允许为空---单个文本触发		$("#device_name").on('blur', function () {			var device_name = $("#device_name").val();			if (device_name == "" || device_name == undefined || device_name == null) {				$("#warn").css({ display: 'block' });			}			else {				$("#warn").css({ display: 'none' });			}		});		$("#device_name").on('focus', function () {			$("#warn").css({ display: 'none' });		});		//		$("#device_nickname").on('blur', function () {			var device_name = $("#device_nickname").val();			if (device_name == "" || device_name == undefined || device_name == null) {				$("#warn2").css({ display: 'block' });			}			else {				$("#warn2").css({ display: 'none' });			}		});		$("#device_nickname").on('focus', function () {			$("#warn2").css({ display: 'none' });		});		//关闭		$(".close_btn").hover(function () { $(this).css({ color: 'black' }) }, function () { $(this).css({ color: '#999' }) }).on('click', function () {			$("#LoginBox").fadeOut("fast");			$("#mask").css({ display: 'none' });		});	});		</script><title>首页</title> </head><body ><div data-role="page" id="home" data-iscroll="enable">	<div id="header" data-role="header"   class="header_div">		<div style="width: 10%;float: left;">			<img   style="width: 30px;height: 30px;margin-left: 10px;margin-top: 5px;" class="home_page_left" src="../images/logo.png">		</div>		<div class="home_page_center">			i农		</div>		<div id="addshed" style='width: 10%;float: left;'>			<img   class="home_page_right"  src="../images/add.png" >		</div>	</div>	<div id="wrapperIndex" class="wrapper" >		<div id="scrollerIndex" class="scroller">			<div id="fpmxList" data-role="content"  style="padding:0px" >				<div id="pullDown" >						<span class="pullDownIcon"></span><span class="pullDownLabel">下拉刷新...</span>				</div>				<div id="devListDiv" class="content"></div>				<div id="pullUp" style="display: none;">						<span class="pullUpIcon"></span><span class="pullUpLabel">上拉加载更多...</span>				</div>			</div>		</div>	    <div id="LoginBox">	        <div class="row1">	            i农添加大棚设备<a href="javascript:void(0)" title="关闭窗口" class="close_btn" id="closeBtn">×</a>	        </div>	        <div class="row">	            大棚设备编号	        </div>	        <div class="row">	            <span class="inputBox">	                <input type="text" style="width: 280px" id="device_name"  placeholder="编号" />	            </span>	        </div>	         <div class="row">	            大棚设备别名	        </div>	        <div class="row">	            <span class="inputBox">	                <input type="text" id="device_nickname"  style="width: 280px"  placeholder="别名" />	            </span>	        </div>	        <div class="row2">	            <a href="javascript:addDevice();" id="loginbtn">确定</a>	        </div>	    </div>	</div>	<div id="footer" data-role="footer" data-position="fixed" data-tap-toggle="false" class="footer_div">		<div data-role="navbar" style="background:transparent;">			<ul>				<li>					<a href="###" data-ajax="false">						<div class="footerUpDiv"><img src="../images/index_icon1_focus.png" height="22px"/></div>						<div style="text-shadow: none;">门户</div>					</a>				</li>				<li><a href="news.html" data-ajax="false">					<div class="footerUpDiv"><img src="../images/index_icon2_focus.png" height="22px" /></div>					<div style="text-shadow: none;">资讯</div></a>				</li>				<li><a href="information.html" data-ajax="false">					<div class="footerUpDiv"><img src="../images/index_icon3_focus.png" height="22px" /></div>					<div style="text-shadow: none;">综合</div></a>				</li>				<li><a href="mine.html" data-ajax="false">					<div class="footerUpDiv"><img src="../images/index_icon4_focus.png" height="22px" /></div>					<div style="text-shadow: none;">我的</div></a>				</li>							</ul>		</div>	</div></div></body></html>